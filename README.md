# Birthday Pizza Bot

Telegram-бот на Grammy JS: читает Excel/CSV, проверяет дни рождения и сообщает вероятность пиццы.

## Как работает бот

- При старте читает `BIRTHDAYS_FILE` и сохраняет список.
- По команде `/today` перечитывает файл и отвечает, есть ли именинники сегодня.
- По команде `/checkid` отвечает ID и имя пользователя (из Telegram-профиля).
- По расписанию один раз в сутки проверяет завтрашнюю дату и, если есть именинники, отправляет сообщение в `CHAT_ID`.

## Быстрый старт

1) Установите зависимости.
2) Скопируйте `.env.example` в `.env` и заполните `BOT_TOKEN`, `CHAT_ID`.
3) Запустите проверку или бота.

## Команды

- Проверка в консоли: `npm run check`
- Отправка в чат один раз: `npm run notify` (ближайшие дни рождения)
- Запуск бота: `npm start`

## Формат данных

Файл `data/birthdays.csv` или `.xlsx` с колонками:

- `name` — имя
- `birthday` — дата в формате `YYYY-MM-DD`
- `chance` — yes/no/maybe (или другое значение)
- `comment` — необязательно

## Ежедневные уведомления (встроенное расписание)

Бот сам планирует следующий запуск проверки, без внешнего cron:

1. Берет время из `DAILY_CHECK_TIME` (формат `HH:MM`, локальное время).
2. Считает, сколько миллисекунд до ближайшего наступления этого времени.
3. Ставит `setTimeout` на вычисленную задержку.
4. Когда таймер сработал, проверяет **завтрашнюю** дату и, если есть именинники, отправляет сообщение в `CHAT_ID`.
5. Сразу после проверки планирует следующую проверку (следующий день).

Дополнительные правила:

- Если завтра именинников нет и это не первый понедельник месяца, сообщение не отправляется.
- По пятницам бот проверяет сразу субботу и воскресенье, чтобы сообщить о выходных днях рождения заранее.
- Пицца-понедельник: каждый первый понедельник месяца бот добавляет отдельную строку в уведомление.

Если бот перезапустится, он заново рассчитает ближайшее время и продолжит ежедневные проверки.
Если `CHAT_ID` не указан, ежедневные уведомления отключены.

## Вебхук (Yandex Cloud)

Если задан `WEBHOOK_URL`, бот работает в режиме вебхука и сам поднимает HTTP-сервер.

Переменные окружения:

- `WEBHOOK_URL` — публичный HTTPS URL вебхука (полный адрес).
- `WEBHOOK_PATH` — путь обработки (по умолчанию `/bot`).
- `WEBHOOK_SECRET` — секретный токен для проверки запросов Telegram.
- `PORT` — порт HTTP-сервера (по умолчанию `3000`).

Пример:

```
WEBHOOK_URL=https://example.yandexcloud.net/bot
WEBHOOK_PATH=/bot
WEBHOOK_SECRET=supersecret
PORT=3000
```

Если `WEBHOOK_URL` не задан, бот запускается в режиме long polling.

## Вебхук (Yandex Cloud Functions)

Для Cloud Functions нужен отдельный входной файл без HTTP-сервера. Используйте `src/yandex-handler.js` как entrypoint функции.

Настройка:

1. В параметрах функции укажите точку входа `src/yandex-handler.handler`.
2. Установите переменные окружения `BOT_TOKEN` и (опционально) `WEBHOOK_SECRET`.
3. Проставьте вебхук Telegram на URL функции.

Важно: в serverless-функции фоновые таймеры не живут между вызовами,
поэтому ежедневный планировщик из `src/index.js` не будет работать.

### Ежедневный запуск через Yandex Cloud Scheduler

1. Создайте вторую функцию с entrypoint `src/yandex-notify-handler.handler`.
2. В переменных окружения задайте `BOT_TOKEN`, `CHAT_ID` и `SCHEDULER_SECRET`.
3. В Scheduler настройте HTTP-запрос по расписанию (например, каждый день в 09:00).
4. Передавайте секрет в заголовке `X-Scheduler-Token` или `Authorization: Bearer <token>`.

Пример запроса Scheduler:

```sh
curl -X POST "https://functions.yandexcloud.net/<notify-function-id>" \
  -H "X-Scheduler-Token: <token>"
```

## Примечания

- Файл задается переменной `BIRTHDAYS_FILE`.
